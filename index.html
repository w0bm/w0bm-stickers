<!DOCTYPE html>
<html lang="en">
    <head>
        <title>w0bm stickers</title>
        <link rel="stylesheet" href="style.css"/>
        <link rel="icon" href="//w0bm.com/favicon.png"/>
        <script src="https://www.google.com/recaptcha/api.js"></script>
        <script src="https://www.paypalobjects.com/api/checkout.js" data-version-4></script>
        <script src="form-submit.js"></script>
        <script src="country-select.js"></script>
        <script src="flash.js"></script>
        <script src="order_overview.js"></script>
        <script>
            let flash, order_id;
            const add_payment_result = (cl, warn) => {
                const payment = document.querySelector("div#payment"),
                      prev_result = document.querySelector("p#payment_result");
                let el = document.createElement("p");
                el.id = "payment_result";
                el.classList.add(cl);
                el.textContent =
                    cl === "error"
                    ? "Payment cancelled!"
                    : "Payment executed successfully!";
                if(warn)
                    el.innerHTML
                        = el.innerHTML
                        + `<br/><span class="payment_warn">${warn}</span>`;
                if(prev_result)
                    prev_result.remove();
                if(cl === "success")
                    document.querySelector("div#paypal_payment").hidden = true;
                payment.appendChild(el);
            };

            const please_wait = b => document.querySelectorAll("*").forEach(el => el.style.cursor = b ? "wait" : "auto");

            paypal.Button.render({
                payment: () => new paypal.Promise((resolve, reject) => {
                    let data = new FormData();
                    data.set("order_id", order_id);
                    fetch("create_payment.php", {
                        method: "POST",
                        body: data
                    }).then(async res => {
                        const json = await res.json();
                        if(res.ok && res.status === 200)
                            resolve(json.data.payment_id);
                        else
                            reject(json);
                    }).catch(reject);
                }),
                onAuthorize: data => {
                    please_wait(true);
                    let formdata = new FormData();
                    formdata.set("order_id", order_id);
                    formdata.set("payer_id", data.payerID);
                    formdata.set("payment_id", data.paymentID);
                    fetch("execute_payment.php", {
                        method: "POST",
                        body: formdata
                    }).then(async res => {
                        please_wait(false);
                        const json = await res.json();
                        if(res.ok && res.status === 200) {
                            flash({
                                type: "success",
                                msg: "Payment executed successfully!"
                            });
                            add_payment_result(
                                "success",
                                json.error.msg === "payment_insertion_failed"
                                ? "Unfortunately we  were not able to store your payment on our side.<br/>Please notify an administrator and sorry for the inconvenience."
                                : null
                            );
                        }
                        else {
                            flash({
                                type: "error",
                                msg: "Payment execution failed!"
                            });
                            add_payment_result("error");
                        }
                    }).catch(err => {
                        please_wait(false);
                        flash({
                            type: "error",
                            msg: "Payment execution failed!"
                        });
                        add_payment_result("error");
                    });
                },
                onCancel: data => {
                    flash({
                        type: "error",
                        msg: "The payment has been cancelled!"
                    });
                    add_payment_result("error");
                },
                style: {
                    size: "medium",
                    color: "blue",
                    shape: "rect"
                }
            }, "div#paypal_payment");

            document.addEventListener("DOMContentLoaded", () => flash = window.init_flash());

            const toggle_order_submit = val => document.querySelector('form[action="add_order.php"] button[type="submit"]').disabled = val;
            const toggle_status_submit = val => document.querySelector('form[action="check_status.php"] button[type="submit"]').disabled = val;

            function enable_order_submit() {
                toggle_order_submit(false);
            }
            function disable_order_submit() {
                toggle_order_submit(true);
            }
            function enable_status_submit() {
                toggle_status_submit(false);
            }
            function disable_status_submit() {
                toggle_status_submit(true);
            }

            function order_submit(form) {
                please_wait(true);
            }
            function order_data(res, json, form) {
                please_wait(false);
                if(res.status === 400 && json.error.msg === "invalid_field_value") {
                    flash({
                        type: "error",
                        msg: `Invalid value for ${json.error.subject}`
                    });
                }
                else if(res.status == 403 && json.error.msg === "captcha_verification_failed") {
                    flash({
                        type: "error",
                        msg: "Couldn't verify captcha! Resetting..."
                    });
                    grecaptcha.reset();
                }
                else if(res.status === 500 && json.error.msg === "captcha_verification_failed") {
                    flash({
                        type: "error",
                        msg: "Couldn't verify captcha! This is an internal error, please notify an administrator!"
                    });
                }
                else if(res.ok && json.success) {
                    flash({
                        type: "success",
                        msg: "Your data has been saved."
                    });
                    grecaptcha.reset();
                    document.querySelector("span#order_id").textContent = order_id = json.data.order_id;
                    document.querySelector("div#overlay").hidden = false;
                }
                else {
                    flash({
                        type: "error",
                        msg: "Oops, something internal broke. Please notify an administrator: https:\/\/w0bm.com/contact\n"
                            + `${res.status} ${res.statusText}\n${JSON.stringify(json)}`
                    });
                }
            }
            function form_error(error, form) {
                please_wait(false);
                flash({
                    type: "error",
                    msg: "submit error: " + JSON.stringify(error)
                });
            }

            function status_submit(form) {
                please_wait(true);
            }
            function status_data(res, json, form) {
                please_wait(false);
            }
        </script>
    </head>
    <body>
        <div id="overlay" hidden>
            <div id="overlay_veil"></div>
            <div id="overlay_content">
                <div id="payment">
                    <p>Your order id is: <span id="order_id"></span><p>
                    <p>You should save it somewhere, you'll be able to get your tracking number with your order id <a href="#">here</a>.</p>
                    <p>You can now pay your order:</p>
                    <div id="paypal_payment"></div>
                </div>
            </div>
        </div>
        <div id="flash">&nbsp;</div>
        <div id="content">
            <h1>w0bm stickers</h1>
            <div class="box">
                <img src="https://w0bm.com/w0bm%20fixed.svg" alt="w0bm logo"/>
                <h3>Hello good people of the internet, you have come to the right place if you always wanted to have a useless and overpriced piece of glued paper to put on your laptop!</h3>
                <h2>Backstory</h2>
                <p>The idea came first in 2015 when sirx was at the Chaos Communication Congress (32C3) and some very nice dudes had their own stickerprinter with them and printed stickers for us in exchange for a small and voluntary donation, so sirx decided to print some w0bm stickers and offered them to the peeps in the IRC that they can have some if they come to the CCH and pick them up by themself, only one guy came and got some stickers from me but at the end of the day there are still people in the IRC who want to have either a new sticker or a sticker in general and for exactly this reason we are now offering you guys, the users of w0bm.com, the chance to get our limited w0bm.com otter sticker, there will be more events like this and we have already a second thing in our minds which is pretty cool!</p>
                <h2>Description</h2>
                <p>Each sticker will be a die cutted ~5x4,5 cm large w0bm otter with play button.</p>
                <p>The stickers will be ordered at stickermule on 1<sup>st</sup> of June. Ordering will be possible only until then.</p>
                <p>
                    Paying is possible only via <b>PayPal</b>.<br/>
                    If you're unable to pay via PayPal, please join our IRC or write us a message on Discord, maybe we'll have additional payment methods available.
                </p>
                <h2>Data Protection</h2>
                <p>Your address is only stored on our server for the time of this event, we will wipe all tables after everyone has received their order.</p>
                <p>We are unable to create any relation between your address and your username on w0bm.</p>
                <p>This page is open source on <a target="_blank" href="https://github.com/w0bm/w0bm-stickers">GitHub</a>, feel free to check the code or report issues!</p>
                <h2>Unanswered Questions?</h2>
                <p>If your question wasn't answered on this page feel free to ask us on Discord or via IRC!</p>
            </div>

            <div class="box">
                <h3>Here you can place your order:</h3>
                <form class="js-submit" data-submit-callback="order_submit" data-callback="order_data" data-error-callback="form_error" action="add_order.php" method="POST">
                    <table>
                        <tbody>
                            <tr>
                                <td>Address:</td>
                                <td>
                                    <input type="text" name="name" placeholder="Full Name" pattern=".+ .+" required/>
                                    <br/>
                                    <input type="text" name="street" placeholder="Street" required/>
                                    <input type="text" name="house_number" placeholder="House Number" pattern="\w{1,5}" required/>
                                    <br/>
                                    <input type="text" name="postal_code" placeholder="Postal Code" pattern="[\w ]{4,10}" required/>
                                    <input type="text" name="city" placeholder="City" required/>
                                    <br/>
                                    <select class="country_select" name="country_code" data-selected="DE"></select>
                                </td>
                            </tr>
                            <tr>
                                <td>Count:</td>
                                <td><input type="number" name="count" value="1" min="1" max="100" required/></td>
                            </tr>
                            <tr>
                                <td>Remark:</td>
                                <td><textarea name="remark" rows="4" cols="30"></textarea></td>
                            </tr>
                            <tr>
                                <td>Order Overview:</td>
                                <td>
                                    <table id="order_overview">
                                        <tbody>
                                            <tr>
                                                <td>Stickers (<span id="item_count"></span>x)</td>
                                                <td><span id="item_price"></span>€</td>
                                            </tr>
                                            <tr>
                                                <td>Packaging</td>
                                                <td>+ <span id="packaging_cost"></span>€</td>
                                            </tr>
                                            <tr>
                                                <td>Shipping</td>
                                                <td>+ <span id="shipping_cost"></span>€</td>
                                            </tr>
                                            <tr>
                                                <td>PayPal Fee</td>
                                                <td>+ <span id="paypal_fee"></span>€</td>
                                            </tr>
                                            <tr>
                                                <td></td>
                                                <td><span id="total_price"></span>€</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><div class="g-recaptcha" data-sitekey="6LfAzlUUAAAAAGN0xhJx8hEahcVR1bpg7PUmAMwb" data-callback="enable_order_submit" data-expired-callback="disable_order_submit" data-theme="dark"></div></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td><button type="submit" disabled>Order</button></td>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>
            <div class="box">
                <h3>Check the status of your order here <span style="color: red;">(NOT IMPLEMENTED YET)</span>:</h3>
                <form class="js-submit" data-submit-callback="status_submit" data-callback="status_data" data-error-callback="form_error" action="check_status.php" method="POST">
                    <table>
                        <tbody>
                            <tr><td><input type="text" name="order_id" placeholder="Order ID" pattern="[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}" required/></td></tr>
                            <tr><td><div class="g-recaptcha" data-sitekey="6LfAzlUUAAAAAGN0xhJx8hEahcVR1bpg7PUmAMwb" data-callback="enable_status_submit" data-expired-callback="disable_status_submit" data-theme="dark"></div></td></tr>
                            <tr><td><button type="submit" disabled>Check Status</button></td></tr>
                        </tbody>
                    </table>
                </form>
            </div>
        </div>
    </body>
</html>
